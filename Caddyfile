:{$PORT} {
    root * ./dist
    file_server

    # Compression gzip/zstd
    encode gzip zstd

    # Cache Long (Immutable) pour les assets hashés par Vite
    @immutable {
        path /assets/*
    }
    header @immutable Cache-Control "public, max-age=31536000, immutable"

    # Cache Moyen (1 semaine) pour les images statiques
    @static {
        path *.jpg *.jpeg *.png *.gif *.ico *.svg *.webp
    }
    header @static Cache-Control "public, max-age=604800"

    # Cache Court (no-cache) pour HTML/JSON
    @nocache {
        path *.html *.json
    }
    header @nocache Cache-Control "no-cache"

    # Sécurité
    header {
        # XSS Protection
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"
        X-Frame-Options "DENY"
        Referrer-Policy "strict-origin-when-cross-origin"

        # Content Security Policy (CSP) - Protection contre XSS
        # ✅ ENABLED: Critical for preventing XSS attacks
        Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com data:; img-src 'self' https: data: blob:; connect-src 'self' {$API_BASE_URL:http://localhost:8000} https:; frame-ancestors 'none'; base-uri 'self'; form-action 'self';"

        # Permissions Policy (formerly Feature-Policy)
        Permissions-Policy "geolocation=(), microphone=(), camera=()"
    }

    # SPA routing (Redirection vers index.html pour les routes Vue)
    try_files {path} /index.html
}

